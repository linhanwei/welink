<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="com.welink.commons.persistence.MikuReturnGoodsDOMapper" >
  <resultMap id="BaseResultMapVO" type="com.welink.commons.vo.MikuReturnGoodsVO" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Jan 14 16:37:48 CST 2016.
    -->
    <!-- <id column="id" property="id" jdbcType="BIGINT" />
    <result column="version" property="version" jdbcType="BIGINT" />
    <result column="trade_id" property="tradeId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="BIGINT" />
    <result column="artificial_id" property="artificialId" jdbcType="BIGINT" />
    <result column="buyer_id" property="buyerId" jdbcType="BIGINT" />
    <result column="agency_id" property="agencyId" jdbcType="BIGINT" />
    <result column="num" property="num" jdbcType="INTEGER" />
    <result column="pic_url" property="picUrl" jdbcType="VARCHAR" />
    <result column="price" property="price" jdbcType="BIGINT" />
    <result column="total_fee" property="totalFee" jdbcType="BIGINT" />
    <result column="share_fee" property="shareFee" jdbcType="BIGINT" />
    <result column="point" property="point" jdbcType="BIGINT" />
    <result column="refund_fee" property="refundFee" jdbcType="BIGINT" />
    <result column="seller_id" property="sellerId" jdbcType="BIGINT" />
    <result column="seller_type" property="sellerType" jdbcType="TINYINT" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="type" property="type" jdbcType="TINYINT" />
    <result column="timeout_action_time" property="timeoutActionTime" jdbcType="TIMESTAMP" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="date_created" property="dateCreated" jdbcType="TIMESTAMP" />
    <result column="last_updated" property="lastUpdated" jdbcType="TIMESTAMP" />
    <result column="consign_time" property="consignTime" jdbcType="TIMESTAMP" />
    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
    <result column="consignee_id" property="consigneeId" jdbcType="BIGINT" />
    <result column="buyer_memo" property="buyerMemo" jdbcType="VARCHAR" />
    <result column="seller_memo" property="sellerMemo" jdbcType="VARCHAR" />
    <result column="return_reason" property="returnReason" jdbcType="VARCHAR" />
    <result column="req_examine" property="reqExamine" jdbcType="TIMESTAMP" />
    <result column="receipt_time" property="receiptTime" jdbcType="TIMESTAMP" />
    <result column="is_subsidy" property="isSubsidy" jdbcType="TINYINT" />
    <result column="subsidy_fee" property="subsidyFee" jdbcType="BIGINT" /> -->
    
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="version" property="version" jdbcType="BIGINT" />
    <result column="trade_id" property="tradeId" jdbcType="BIGINT" />
    <result column="order_id" property="orderId" jdbcType="BIGINT" />
    <result column="artificial_id" property="artificialId" jdbcType="BIGINT" />
    <result column="buyer_id" property="buyerId" jdbcType="BIGINT" />
    <result column="num" property="num" jdbcType="INTEGER" />
    <result column="pic_url" property="picUrl" jdbcType="VARCHAR" />
    <result column="price" property="price" jdbcType="BIGINT" />
    <result column="total_fee" property="totalFee" jdbcType="BIGINT" />
    <result column="refund_fee" property="refundFee" jdbcType="BIGINT" />
    <result column="status" property="status" jdbcType="TINYINT" />
    <result column="timeout_action_time" property="timeoutActionTime" jdbcType="TIMESTAMP" />
    <result column="title" property="title" jdbcType="VARCHAR" />
    <result column="date_created" property="dateCreated" jdbcType="TIMESTAMP" />
    <result column="last_updated" property="lastUpdated" jdbcType="TIMESTAMP" />
    <result column="consign_time" property="consignTime" jdbcType="TIMESTAMP" />
    <result column="finish_time" property="finishTime" jdbcType="TIMESTAMP" />
    <result column="consignee_id" property="consigneeId" jdbcType="BIGINT" />
    <result column="buyer_memo" property="buyerMemo" jdbcType="VARCHAR" />
    <result column="seller_memo" property="sellerMemo" jdbcType="VARCHAR" />
    <result column="return_reason" property="returnReason" jdbcType="VARCHAR" />
    <result column="req_examine" property="reqExamine" jdbcType="TIMESTAMP" />
    <result column="receipt_time" property="receiptTime" jdbcType="TIMESTAMP" />
    <result column="is_subsidy" property="isSubsidy" jdbcType="TINYINT" />
    <result column="subsidy_fee" property="subsidyFee" jdbcType="BIGINT" />
    <result column="trade_status" property="tradeStatus" jdbcType="TINYINT" />
    
    <result column="express_company" property="expressCompany" jdbcType="VARCHAR" />
    <result column="express_no" property="expressNo" jdbcType="VARCHAR" />
    <result column="returnName" property="returnName" jdbcType="VARCHAR" />
    <result column="returnMobile" property="returnMobile" jdbcType="VARCHAR" />
    <result column="returnUserAddr" property="returnUserAddr" jdbcType="VARCHAR" />
    
    <result column="isTimeOut" property="isTimeOut" jdbcType="INTEGER" />
    <result column="orderDateCreated" property="orderDateCreated" jdbcType="TIMESTAMP" />
  </resultMap>
  
  <select id="getReturnGoodsVOList" resultMap="BaseResultMapVO" parameterType="java.util.Map" >
    select
    <if test="distinct" >
      distinct
    </if>
    	if(rg.id is null, tr.status, if(rg.status=6, tr.status, rg.trade_status)) as trade_status,
		o.trade_id, o.id as order_id, o.artificial_id, o.title, o.buyer_id, 
		o.num, o.pic_url, o.price, o.total_fee, o.return_status as status, o.date_created as orderDateCreated,
		rg.id, rg.refund_fee, rg.timeout_action_time, rg.end_time, rg.consignee_id, rg.consign_time, rg.finish_time, rg.buyer_memo, rg.seller_memo,
		rg.return_reason, rg.req_examine, rg.receipt_time, rg.is_subsidy, rg.subsidy_fee,rg.date_created,
		IF(rg.timeout_action_time > NOW(),0,if(rg.id > 0, 1, 0)) as 'isTimeOut',
		lo.express_company, lo.express_no, lo.contact_name as returnName, lo.addr as returnUserAddr, lo.mobile as returnMobile
	from t_order o LEFT JOIN trade tr on o.trade_id = tr.trade_id 
		LEFT JOIN item it on o.artificial_id = it.id
		LEFT JOIN miku_return_goods rg on o.id = rg.order_id and rg.trade_id = o.trade_id
		LEFT JOIN logistics lo on rg.consignee_id = lo.id and rg.consignee_id > 0
    <where>
    	o.trade_id > 0 AND o.artificial_id > 0 AND tr.status != 20  AND it.type != 7 AND
    	it.isrefund = 1 AND
		<!-- (tr.timeout_action_time > DATE_SUB(NOW(), INTERVAL 7 DAY) and o.return_status=0 -->
		(	
			(tr.timeout_action_time > NOW() and o.return_status=0
				and tr.status not in(2,8,9) and rg.id is null
			)
			or (rg.id is not null and rg.status != -1)
		)
	    <if test="profileId != null" >
	    	and o.buyer_id = #{profileId,jdbcType=BIGINT}
	    </if>
	    <if test="orderId != null" >
	    	and o.id = #{orderId,jdbcType=BIGINT}
	    </if>
	    <if test="returnStatus != null" >
	    	and o.return_status = #{returnStatus,jdbcType=TINYINT}
	    </if>
	    <choose>
            <when test="isTimeOut != null and isTimeOut == 0">
            	<!-- 未过期 -->
                and rg.timeout_action_time >= NOW()
            </when>
            <when test="isTimeOut != null and isTimeOut == 1">
            	<!-- 已过期 -->
                and rg.timeout_action_time &lt; NOW()
            </when>
        </choose>
    </where>
    <if test="orderByClause != null" >
      order by ${orderByClause}
    </if>
    <if test="limit != null" >
      limit ${limit}
    </if>
    <if test="offset != null" >
      offset ${offset}
    </if>
  </select>
  
</mapper>